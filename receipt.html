<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8">
  <title>Order Receipt — Songs for Choirs</title>
  <meta name="description" content="Thank you for your order from Songs for Choirs. Download your licensed scores.">
  <meta property="og:title" content="Order Receipt — Songs for Choirs">
  <meta property="og:description" content="Thank you for your order from Songs for Choirs. Download your licensed scores.">
  <link rel="stylesheet" href="styles.css?v=999">
</head>

<body class="receipt-page">

  <!-- Consistent header -->
  <header class="site-header">
    <div class="wrap">
      <h1 class="site-logo">songs<span class="gold">for</span>choirs</h1>
      <p class="tagline">Secure licensed downloads — trusted by choirs.</p>
    </div>
  </header>

  <!-- Main navigation -->
  <nav class="site-nav">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="choral.html">Choral</a></li>
      <li><a href="children.html">Children</a></li>
      <li><a href="other.html">Other</a></li>
      <li><a href="news.html">News</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <!-- Receipt panel -->
<div class="panel">  
  <h2>Thank you <span class="gold">for</span> your order</h2>

    <p><strong>Title:</strong> <span id="title"></span></p>
<p><strong>Choir:</strong> <span id="choir"></span></p>
<p><strong>Order number:</strong> <span id="order"></span></p>
<p><strong>Amount:</strong> £<span id="amount"></span></p>
<p><strong>Copies:</strong> <span id="copies"></span></p>

    <p><em>Our sheet music is delivered in ZIP files.  
We kindly ask that you respect our copyright and print only one copy of each numbered part.</em></p>

<p><em>Once opened these pdfs will print double-sided only if your printer supports that option.  
If you prefer to save ink (and possibly paper), you can start printing from page 2 to skip the title page.</em></p>

  <button type="submit" id="sendEmail">Sending your sheet music</button>

<p><em>Our Head of Sums, Spelling & Syntax has pointed out that paper is only saved if you begin with an odd number of pages.</em></p>

  </div>

  <footer class="site-footer">
    <p>© 2025 <a href="https://www.songsforchoirs.com">www.songsforchoirs.com</a> — All rights reserved.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
    
      const params = new URLSearchParams(window.location.search);
      const order = params.get("order");
      if (!order) return;
    
      fetch(`/get-order?order=${order}`)
        .then(res => {
          if (!res.ok) throw new Error("Order not found");
          return res.json();
        })
        .then(data => {
    
          // Populate receipt fields
          document.getElementById("title").textContent = data.title;
          document.getElementById("choir").textContent = data.choir;
          document.getElementById("order").textContent = order;
          document.getElementById("amount").textContent = data.amount;
          document.getElementById("copies").textContent = data.copies;
    
          // Only send fulfilment email once per order
          const sendBtn = document.getElementById("sendEmail");
          const emailSentKey = `emailSent_${order}`;
    
          if (!localStorage.getItem(emailSentKey)) {
    
          // Trigger fulfilment via ZIP route
          fetch(`/${encodeURIComponent(data.title)}.zip?choir=${encodeURIComponent(data.choir)}&order=${encodeURIComponent(order)}&copies=${data.copies}&amount=${encodeURIComponent(data.amount)}`)
            .then(res => {
              if (!res.ok) throw new Error("ZIP generation failed");
              return res.blob(); // We don't actually need the blob, but this ensures execution
            })
            .then(() => {
              localStorage.setItem(emailSentKey, "true");
              console.log("Fulfilment triggered");
            })
            .catch(err => {
              console.error("Fulfilment error:", err);
            });
  
            //fetch("/send-email", {
            //method: "POST",
            //headers: { "Content-Type": "application/json" },
            //body: JSON.stringify({
            //title: data.title,
            //choir: data.choir,
            //copies: data.copies,
            //email: data.email,
            //order: order,
            //amount: data.amount,
            //currency: "GBP"
            //})
            //})
            
            //.then(res => {
            //if (!res.ok) throw new Error("Email failed");
    
            //localStorage.setItem(emailSentKey, "true");
    
            //if (sendBtn) {
            //sendBtn.textContent = "✅ Delivered to your email";
            //sendBtn.disabled = true;
            //sendBtn.style.opacity = "0.75";
            //sendBtn.style.cursor = "default";
            //}
            //})
            //.catch(err => {
            //console.error(err);
            //if (sendBtn) {
            //sendBtn.textContent = "Problem sending — please try again";
            //}
            //});
    
          } else {
            if (sendBtn) {
              sendBtn.textContent = "✅ Delivered to your email";
              sendBtn.disabled = true;
            }
          }
    
        })
        .catch(err => {
          console.error(err);
          document.body.innerHTML = "<h2>Unable to load receipt.</h2>";
        });
    });

    </script>
    
</body>
</html>
